@page "/matches/{MatchId:int}"
@inject HttpClient _client
@inject IJSRuntime js
@inject NavigationManager NavigationManager
@attribute [Authorize]

<div class="chat-wrapper">
    <h3>Message Chat</h3>

    @if (!initialized)
    {
        <p>Loading chat...</p>
    }
    else
    {
        <div class="chat-container">
            <div class="messages">
                @foreach (var message in messages)
                {
                    <div class="@GetMessageClass(message)">
                        <div class="message-content">
                            <strong>@GetSenderName(message.SenderId):</strong> @message.Content
                            @if (message.SenderId == loggedInUserId)
                            {
                                <button @onclick="() => EditMessage(message)">Edit</button>
                                <button @onclick="() => DeleteMessage(message.Id)">Delete</button>
                            }
                        </div>
                        <div class="message-timestamp">
                            @message.Timestamp.ToString("HH:mm")
                        </div>
                    </div>
                }
            </div>
            <div class="message-input">
                <input type="text" @bind="newMessage" placeholder="Type a message..." />
                <button @onclick="SendMessage">Send</button>
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public int MatchId { get; set; }
    private List<Message> messages = new List<Message>();
    private Dictionary<int, string> userNames = new Dictionary<int, string>();
    private string newMessage;
    private int loggedInUserId;
    private Match match;
    private int MatchUserId;
    private bool initialized = false;
    private System.Threading.Timer? pollingTimer;

    protected override async Task OnInitializedAsync()
    {
        var userIdString = await js.InvokeAsync<string>("sessionStorage.getItem", "loggedInUserId");
        if (!string.IsNullOrEmpty(userIdString) && int.TryParse(userIdString, out loggedInUserId))
        {
            await LoadUserNames();
            await LoadMatchedUserInfo();
            await LoadMessages();
            initialized = true;

            pollingTimer = new Timer(Callback, null, 0, 5000); // Poll every 5 seconds
        }
    }

    private void Callback(object? state)
    {
        InvokeAsync(async () =>
        {
            await LoadMessages();
            StateHasChanged();
        });
    }

    private async Task LoadUserNames()
    {
        var users = await _client.GetFromJsonAsync<List<User>>($"{Endpoints.UsersEndpoint}");
        if (users != null)
        {
            foreach (var user in users)
            {
                userNames[user.Id] = user.FirstName; // or FullName etc.
            }
        }
    }

    private async Task LoadMatchedUserInfo()
    {
        match = await _client.GetFromJsonAsync<Match>($"{Endpoints.MatchesEndpoint}/{MatchId}");

        if (match != null)
        {
            // Set MatchUserId to the ID of the other user in the match
            MatchUserId = (match.User1Id == loggedInUserId) ? match.User2Id : match.User1Id;
        }
        else
        {
            // Handle the case where the match is null if necessary
        }
    }

    private async Task LoadMessages()
    {
        try
        {
            var allMessages = await _client.GetFromJsonAsync<List<Message>>($"{Endpoints.MessagesEndpoint}");

            if (allMessages != null)
            {
                messages = allMessages.Where(m =>
                    (m.SenderId == loggedInUserId || m.ReceiverId == MatchUserId) ||
                    (m.SenderId == MatchUserId || m.ReceiverId == loggedInUserId)).ToList();
            }
        }
        catch (Exception ex)
        {
            // Handle exceptions
        }
    }

    private string GetMessageClass(Message message)
    {
        return message.SenderId == loggedInUserId ? "message-sent" : "message-received";
    }

    private string GetSenderName(int senderId)
    {
        return userNames.TryGetValue(senderId, out var name) ? name : "Unknown";
    }

    private async Task SendMessage()
    {
        if (!string.IsNullOrEmpty(newMessage))
        {
            var message = new Message
                {
                    SenderId = loggedInUserId,
                    ReceiverId = MatchUserId,
                    Content = newMessage,
                    Timestamp = DateTime.Now
                };

            var result = await _client.PostAsJsonAsync(Endpoints.MessagesEndpoint, message);
            if (result.IsSuccessStatusCode)
            {
                newMessage = string.Empty;
                await LoadMessages(); // Reload messages
            }
            else
            {
                // Handle sending error
            }
        }
    }

    public void Dispose()
    {
        pollingTimer?.Dispose();
    }

    private async Task EditMessage(Message messageToEdit)
    {
        // Prompt the user for the new message content
        var newContent = await js.InvokeAsync<string>("prompt", "Edit your message:", messageToEdit.Content);

        if (!string.IsNullOrEmpty(newContent))
        {
            messageToEdit.Content = newContent;
            await _client.PutAsJsonAsync($"{Endpoints.MessagesEndpoint}/{messageToEdit.Id}", messageToEdit);
            await LoadMessages();
        }
    }

    private async Task DeleteMessage(int messageId)
    {
        var confirmed = await js.InvokeAsync<bool>("confirm", "Are you sure you want to delete this message?");
        if (confirmed)
        {
            await _client.DeleteAsync($"{Endpoints.MessagesEndpoint}/{messageId}");
            await LoadMessages();
        }
    }
}