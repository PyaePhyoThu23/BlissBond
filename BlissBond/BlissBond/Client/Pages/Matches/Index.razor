@page "/matches/"
@inject HttpClient _client
@inject IJSRuntime js
@attribute [Authorize]

<h3 class="card-title">Your Matches</h3>
<br />

@if (matches == null)
{
    <div class="alert alert-info">Loading matches...</div>
}
else if (matches.Any())
{
    <table class="table table-responsive">
        <thead>
            <tr>
                <th>User1</th>
                <th>User2</th>
                <th>Match Status</th>
                <!-- Other columns as needed -->
            </tr>
        </thead>
        <tbody>
            @foreach (var match in matches)
            {
                var user1 = users.FirstOrDefault(u => u.Id == match.User1Id);
                var user2 = users.FirstOrDefault(u => u.Id == match.User2Id);
                <tr>
                    <td>@(user1?.FirstName ?? "Unknown")</td>
                    <td>@(user2?.FirstName ?? "Unknown")</td>
                    <td>@match.MatchStatus</td>
                </tr>
            }
        </tbody>
    </table>
}
else
{
    <p>No matches found.</p>
}

@code {
    private List<Match>? matches;
    private List<User>? users;
    private int loggedInUserId; // The ID of the logged-in user

    protected override async Task OnInitializedAsync()
    {
        var result = await js.InvokeAsync<string>("sessionStorage.getItem", "loggedInUserId");
        if (!string.IsNullOrEmpty(result) && int.TryParse(result, out int parsedUserId))
        {
            loggedInUserId = parsedUserId;
        }

        await LoadData();
    }

    private async Task LoadData()
    {
        var allMatches = await FetchAllMatches();
        if (allMatches != null)
        {
            matches = allMatches.Where(m => m.User1Id == loggedInUserId || m.User2Id == loggedInUserId).ToList();

            var userIds = matches.Select(m => m.User1Id).Concat(matches.Select(m => m.User2Id)).Distinct();
            users = await FetchUserDetails(userIds);
        }
        else
        {
            matches = new List<Match>();
        }
    }

    private async Task<List<Match>> FetchAllMatches()
    {
        var response = await _client.GetFromJsonAsync<List<Match>>(Endpoints.MatchesEndpoint);
        return response ?? new List<Match>();
    }

    private async Task<List<User>> FetchUserDetails(IEnumerable<int> userIds)
    {
        var userDetails = new List<User>();

        foreach (var userId in userIds)
        {
            var user = await _client.GetFromJsonAsync<User>($"{Endpoints.UsersEndpoint}/{userId}");
            if (user != null)
            {
                userDetails.Add(user);
            }
        }

        return userDetails;
    }

    // Define the Match and User classes as per your application's structure
    
}
